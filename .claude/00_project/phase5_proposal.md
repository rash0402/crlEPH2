# Phase 5 実装提案書

**EPH v2.1: 完全検証・可視化・最適化**

---

## 📋 Phase 5 の目的

Phase 4でV2（相転移検出）を達成した。Phase 5では残りの検証目標（V1, V3-V5）を達成し、EPH v2.1フレームワークを完成させる。

---

## 🎯 検証目標（V1, V3-V5）

### V1: 信念更新検証

**目標**: 予測誤差フィードバックループの妥当性検証

**検証項目**:
1. **予測誤差の計算精度**
   - PE = |Δv| / V_MAX が適切な範囲 [0, 1] に収まる
   - 大きな行為変化 → 高いPE
   - 小さな行為変化 → 低いPE

2. **Haze推定への影響**
   - 高PE → Haze増加（不確実性認識）
   - 低PE → Haze減少（確信度向上）
   - EMAフィルタの応答特性確認

3. **フィードバックループの収束性**
   - 長時間実行での安定性
   - 振動・発散の有無

**実装**:
```cpp
TEST(V1Validation, PredictionError_ReflectsActionChange) {
    // 大きな行為変化 → 高PE
    // 小さな行為変化 → 低PE
}

TEST(V1Validation, HazeFeedback_ConvergesStably) {
    // 1000ステップ実行で収束確認
}
```

**推定時間**: 2-3時間

---

### V3: ボトムアップ顕著性検証

**目標**: SPMの勾配情報が行為選択に正しく反映されることを検証

**検証項目**:
1. **勾配方向への移動**
   - SPMの勾配が大きい方向へエージェントが移動
   - Epistemic項（⟨h⟩·⟨|∇SPM|⟩）の効果確認

2. **Saliency依存性**
   - 高Saliency領域への誘引
   - 低Saliency領域からの回避

3. **複数ピークでの選択**
   - 複数の顕著性ピークがある場合の行為選択
   - Explorationとexploitationのバランス

**実装**:
```cpp
TEST(V3Validation, AgentMovesToward_HighSaliencyGradient) {
    // 勾配場を設定し、エージェントが勾配方向に移動することを確認
}

TEST(V3Validation, MultiPeak_SelectionBehavior) {
    // 複数ピークSPMでの探索挙動
}
```

**推定時間**: 3-4時間

---

### V4: 長時間安定性検証

**目標**: 10000ステップ以上の長時間実行での数値安定性確認

**検証項目**:
1. **数値爆発の防止**
   - 位置・速度・疲労・Hazeが有限範囲に留まる
   - NaN/Inf の発生無し

2. **定常状態への収束**
   - エージェント動態が定常状態に到達
   - φ、χなどの観測量が安定

3. **メモリリークの無し**
   - 長時間実行でメモリ使用量が一定

**実装**:
```cpp
TEST(V4Validation, LongRun_NumericalStability) {
    // 10000ステップ実行
    for (int t = 0; t < 10000; ++t) {
        swarm.update_all_agents(spm, dt);
        // 毎1000ステップで数値安定性チェック
    }
}
```

**推定時間**: 2-3時間

---

### V5: 大規模群検証

**目標**: エージェント数N=100-200での拡張性確認

**検証項目**:
1. **相転移の再現性**
   - N=50での結果（β_c≈0.098）がN=100でも再現されるか
   - 有限サイズスケーリング理論との整合性

2. **計算時間のスケーリング**
   - O(N²)の近傍検索がボトルネックになる可能性
   - 並列化の効果測定

3. **統計精度の向上**
   - 大規模群でのφ、χの標準誤差減少

**実装**:
```cpp
TEST(V5Validation, LargeSwarm_PhasTransitionReproduced) {
    SwarmManager swarm(100, 0.098, 6);  // N=100
    // β_c検出がN=50と一致することを確認
}

TEST(V5Validation, Scalability_ComputationalCost) {
    // N=50, 100, 200での実行時間測定
}
```

**推定時間**: 4-5時間

---

## 🎨 可視化ツール実装

### 1. φ(β)、χ(β)グラフ生成

**目的**: 実験結果を視覚的に表示

**実装**:
- gnuplot または matplotlib（Python binding）
- CSV出力 → グラフ生成スクリプト

**例**:
```bash
./packages/eph_phase/tools/plot_phase_transition.py results.csv
```

**推定時間**: 3-4時間

---

### 2. エージェント軌跡アニメーション

**目的**: エージェントの動きを可視化

**実装**:
- JSON形式で位置・速度・Hazeを時系列出力
- matplotlibアニメーションまたはWeb可視化

**推定時間**: 5-6時間

---

### 3. Haze場の時間発展

**目的**: Haze場の空間分布を可視化

**実装**:
- 2D空間にエージェントをプロット
- 色でHaze値を表現（ヒートマップ）

**推定時間**: 4-5時間

---

## ⚡ パフォーマンス最適化

### 1. OpenMP並列化

**対象**:
```cpp
void SwarmManager::update_all_agents(const spm::SaliencyPolarMap& spm, Scalar dt) {
    #pragma omp parallel for
    for (size_t i = 0; i < agents_.size(); ++i) {
        agents_[i]->update(spm, dt);
    }
    // 位置同期・MB破れは逐次実行
}
```

**期待効果**: 2-4倍高速化（4-8コア環境）

**推定時間**: 2-3時間

---

### 2. 数値微分の高速化

**現在**: 中心差分で各方向2回のEFE計算（計4回）

**改善案**:
- 自動微分（Eigen::AutoDiffScalar）
- 解析的勾配（可能な項のみ）

**期待効果**: 行為選択が2倍高速化

**推定時間**: 4-5時間

---

### 3. メモリ効率改善

**対象**:
- Matrix12x12の不要なコピー削減
- Eigenの`.noalias()`活用
- move semanticsの導入

**期待効果**: メモリ使用量10-20%削減

**推定時間**: 3-4時間

---

## 🔬 パラメータ感度解析

### 1. HAZE係数の影響

**目的**: HAZE_COEFF_A,B,C,Dの最適バランス探索

**実験設計**:
```
固定: A+B+C+D = 1.0
変動: (A,B,C,D) のバランス
評価: β_c検出精度、χ_maxの明瞭度
```

**推定時間**: 6-8時間

---

### 2. 近傍数zの影響

**実験**: z ∈ {4, 6, 8, 10}

**予想**:
- z増加 → 結合強度増 → β_c減少
- 平均場理論との比較

**推定時間**: 4-5時間

---

### 3. 疲労パラメータの最適化

**実験**: FATIGUE_RATE / RECOVERY_RATE 比を変化

**評価**: エージェント動態の多様性

**推定時間**: 3-4時間

---

## 📝 ドキュメント整備

### 1. API リファレンス

**内容**:
- 全クラス・メソッドのDoxygen コメント
- 使用例・コードスニペット

**推定時間**: 8-10時間

---

### 2. チュートリアル

**内容**:
- 初心者向け実行ガイド
- カスタムエージェントの実装例
- パラメータチューニングガイド

**推定時間**: 6-8時間

---

### 3. 学術論文ドラフト

**セクション**:
1. Introduction（FEP、Active Inference、EPH）
2. Methods（アーキテクチャ、アルゴリズム）
3. Results（V0-V5検証結果）
4. Discussion（意義、限界、将来研究）

**推定時間**: 20-30時間

---

## 📊 Phase 5 実装スケジュール

### Milestone 1: 残り検証目標達成（2-3日）

| タスク | 時間 | 優先度 |
|--------|------|--------|
| V1実装・検証 | 3h | 高 |
| V3実装・検証 | 4h | 高 |
| V4実装・検証 | 3h | 中 |
| V5実装・検証 | 5h | 中 |
| **小計** | **15h** | - |

---

### Milestone 2: 可視化ツール（2-3日）

| タスク | 時間 | 優先度 |
|--------|------|--------|
| φ(β)グラフ生成 | 4h | 高 |
| 軌跡アニメーション | 6h | 中 |
| Haze場可視化 | 5h | 低 |
| **小計** | **15h** | - |

---

### Milestone 3: パフォーマンス最適化（2-3日）

| タスク | 時間 | 優先度 |
|--------|------|--------|
| OpenMP並列化 | 3h | 高 |
| 数値微分高速化 | 5h | 中 |
| メモリ効率改善 | 4h | 低 |
| **小計** | **12h** | - |

---

### Milestone 4: パラメータ研究（オプション、3-4日）

| タスク | 時間 | 優先度 |
|--------|------|--------|
| HAZE係数感度解析 | 8h | 低 |
| 近傍数z研究 | 5h | 低 |
| 疲労パラメータ | 4h | 低 |
| **小計** | **17h** | - |

---

### Milestone 5: ドキュメント（オプション、1-2週間）

| タスク | 時間 | 優先度 |
|--------|------|--------|
| APIリファレンス | 10h | 中 |
| チュートリアル | 8h | 中 |
| 論文ドラフト | 30h | 低 |
| **小計** | **48h** | - |

---

## 🎯 Phase 5 完了基準

### 必須条件（Milestone 1-2）

- [ ] V1検証達成（予測誤差フィードバック）
- [ ] V3検証達成（ボトムアップ顕著性）
- [ ] V4検証達成（長時間安定性）
- [ ] V5検証達成（大規模群）
- [ ] φ(β)、χ(β)グラフ生成ツール完成
- [ ] 全テスト通過（推定170-180テスト）

### 推奨条件（Milestone 3）

- [ ] OpenMP並列化実装
- [ ] 2倍以上の高速化達成
- [ ] メモリ効率改善

### オプション条件（Milestone 4-5）

- [ ] パラメータ感度解析完了
- [ ] APIリファレンス完成
- [ ] 論文ドラフト完成

---

## 💡 Phase 5 の技術的課題

### 課題1: 有限サイズ効果

**問題**: N=50は統計力学的に「小さい」

**対策**:
- V5でN=100, 200を試行
- 有限サイズスケーリング理論を適用
- β_c(N) → β_c(∞) の外挿

---

### 課題2: 計算コストのスケーリング

**問題**: O(N²)の近傍検索

**対策**:
- 空間分割（Quad-tree、k-d tree）
- 近傍リスト更新頻度の削減
- 並列化

---

### 課題3: パラメータ空間の広さ

**問題**: (HAZE係数、z、LR、疲労など)多次元

**対策**:
- 感度解析で重要パラメータを特定
- 2次以上の相互作用は無視（線形近似）
- Bayesian Optimization適用（オプション）

---

## 📚 Phase 5 で参考にすべき文献

### 有限サイズスケーリング

- Binder, K., & Heermann, D. W. (2010). "Monte Carlo simulation in statistical physics."
- Cardy, J. (1988). "Finite-size scaling."

### 並列計算

- Chapman, B., et al. (2007). "Using OpenMP: Portable Shared Memory Parallel Programming."

### Active Inference実装

- Da Costa, L., et al. (2020). "Active inference on discrete state-spaces: A synthesis." *Journal of Mathematical Psychology*.

---

## 🏆 Phase 5 完了後の状態

### 定量的成果

- **テスト数**: 170-180（Phase 4: 154 + V1-V5関連）
- **検証目標**: V0-V5全達成（100%）
- **可視化ツール**: 3種類以上
- **パフォーマンス**: 2-4倍高速化

### 学術的意義

1. **FEPの完全実装例**
   - Expected Free Energy
   - 予測誤差フィードバック
   - Markov Blanket Breaking

2. **相転移の計算論的モデル**
   - 臨界現象の再現
   - Active Inferenceとの統合

3. **マルチエージェント協調の新手法**
   - 情報論的結合（MB破れ）
   - 創発的相転移

---

## 📅 推奨実装順序

### Week 1: 検証目標完了
- Day 1-2: V1, V3実装・検証
- Day 3-4: V4, V5実装・検証
- Day 5: 統合テスト・デバッグ

### Week 2: 可視化・最適化
- Day 1-2: φ(β)グラフ生成
- Day 3-4: OpenMP並列化
- Day 5: 軌跡アニメーション（オプション）

### Week 3-4: ドキュメント・研究（オプション）
- Week 3: パラメータ感度解析
- Week 4: 論文ドラフト作成

---

## 🎯 次のアクション

Phase 4完了後、以下の選択肢から選ぶ：

**A) 最小構成**: Milestone 1のみ（V1-V5達成、約15時間）

**B) 推奨構成**: Milestone 1-2（検証+可視化、約30時間）

**C) 完全版**: Milestone 1-3（検証+可視化+最適化、約42時間）

**D) 学術版**: Milestone 1-5全て（約107時間、2-3週間）

---

**提案書作成日**: 2026-02-03
**Phase 4状態**: 完了待ち
**Phase 5開始予定**: Phase 4完了直後

---

*この提案書は、Phase 4完了後にユーザーと議論して最終化される。*
